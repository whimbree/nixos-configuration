version: "3.9"
services:
  nextcloud:
    build: nextcloud
    container_name: nextcloud
    environment:
      - PUID=1420
      - PGID=1420
      - TZ=America/New_York
    volumes:
      - /services/nextcloud/config:/config
      - /ocean/services/nextcloud:/data
    restart: unless-stopped
    depends_on:
      - nextcloud-mariadb
      - nextcloud-collabora
      - nextcloud-redis
    networks:
      - nextcloud
    healthcheck:
      test: curl --fail --insecure https://localhost || exit 1
      interval: 10s
      retries: 6
      start_period: 10s
      timeout: 2s

  nextcloud-mariadb:
    image: lscr.io/linuxserver/mariadb:latest
    container_name: nextcloud-mariadb
    environment:
      - PUID=1420
      - PGID=1420
      - TZ=America/New_York
      - MYSQL_ROOT_PASSWORD=password
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
      - MYSQL_PASSWORD=nextcloud
    volumes:
      - /services/nextcloud/mariadb:/config
    restart: unless-stopped
    networks:
      - nextcloud
    healthcheck:
      test: nc -zv localhost 3306 || exit 1
      interval: 10s
      retries: 6
      start_period: 10s
      timeout: 2s

  nextcloud-collabora:
    image: collabora/code
    container_name: nextcloud-collabora
    restart: unless-stopped
    networks:
      - nextcloud
    healthcheck:
      test: curl --fail --insecure https://localhost:9980 || exit 1
      interval: 10s
      retries: 6
      start_period: 10s
      timeout: 2s

  nextcloud-redis:
    image: redis
    container_name: nextcloud-redis
    environment:
      - PUID=1420
      - PGID=1420
      - TZ=America/New_York
    volumes:
      - /services/nextcloud/redis:/data
    command: redis-server --requirepass nextcloud
    restart: unless-stopped
    networks:
      - nextcloud
    healthcheck:
      test: redis-cli -a nextcloud ping | grep PONG
      interval: 10s
      retries: 6
      start_period: 10s
      timeout: 2s

  nextcloud-client-push:
    build: client-push
    container_name: nextcloud-client-push
    restart: unless-stopped
    volumes:
      - /services/nextcloud/config/www/nextcloud/config/config.php:/config.php:ro
    command: /notify_push /config.php
    networks:
      - nextcloud

  nextcloud-spreed-backend:
    container_name: nextcloud-spreed-backend
    build: spreed
    volumes:
      - /services/nextcloud/spreed/server.conf:/config/server.conf:ro
    networks:
      - nextcloud
    restart: unless-stopped
    depends_on:
      - nextcloud-spreed-nats
      - nextcloud-spreed-janus
      - nextcloud-spreed-coturn
    healthcheck:
      test: wget -qO- localhost:8080 2>&1 | grep 404 || exit 1
      interval: 10s
      retries: 6
      start_period: 10s
      timeout: 2s
  nextcloud-spreed-nats:
    container_name: nextcloud-spreed-nats
    image: nats:2.1
    volumes:
      - /services/nextcloud/spreed/gnatsd.conf:/config/gnatsd.conf:ro
    command: ["-c", "/config/gnatsd.conf"]
    networks:
      - nextcloud
    restart: unless-stopped
  nextcloud-spreed-janus:
    container_name: nextcloud-spreed-janus
    build: janus
    command: ["janus", "--full-trickle"]
    networks:
      - nextcloud
    restart: unless-stopped
    healthcheck:
      test: curl localhost:8188 || exit 1
      interval: 10s
      retries: 6
      start_period: 10s
      timeout: 2s
  nextcloud-spreed-coturn:
    container_name: nextcloud-spreed-coturn
    image: coturn/coturn
    volumes:
      - /services/nextcloud/spreed/turnserver.conf:/etc/coturn/turnserver.conf:ro
    networks:
      - nextcloud
    restart: unless-stopped

networks:
  nextcloud:
    name: nextcloud
    external: true